{% extends "base.html" %}
{% block content %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Research Workspace - AI Research Assistant</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet"/>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

    <style>
        * { font-family: 'Poppins', sans-serif; }
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        .chat-message { animation: fadeIn 0.3s ease-out; }

        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f5f9; border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1; border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
</head>

<body class="bg-gray-50 text-gray-800">

<main class="flex-1 px-4 sm:px-10 py-6 w-full">
    <div class="max-w-[1600px] mx-auto">

        <div class="flex items-center justify-between mb-6 fade-in">
            <div>
                <h1 class="text-2xl font-bold text-gray-900 flex items-center gap-2">
                    Research Workspace
                    <span class="text-primary">– {{ plan.company_name }}</span>
                </h1>

                <p class="text-sm text-gray-500 mt-1 flex items-center gap-3">
                    <span class="flex items-center gap-1">
                        <span class="material-symbols-outlined text-base">science</span>
                        Depth: {{ plan.depth }}
                    </span>

                    <span class="text-gray-300">•</span>

                    <span class="flex items-center gap-1">
                        <span class="material-symbols-outlined text-base">tag</span>
                        ID: {{ conversation_id }}
                    </span>
                    
                    {% if plan.metadata.conflicts_detected %}
                    <span class="text-gray-300">•</span>
                    <span class="flex items-center gap-1 font-semibold text-red-600 bg-red-100 px-2 rounded-full">
                        <span class="material-symbols-outlined text-sm">error</span>
                        Conflict Detected
                    </span>
                    {% endif %}
                </p>
            </div>

            <div class="flex flex-wrap gap-2">
                <form method="post" action="{{ url_for('generate_feedback_ui', conversation_id=conversation_id) }}">
                    <button
                        class="inline-flex items-center gap-2 px-4 py-2 rounded-lg border-2 border-primary text-primary bg-blue-50 hover:bg-blue-100 font-medium text-sm transition-all">
                        <span class="material-symbols-outlined text-lg">star</span>
                        Generate Feedback
                    </button>
                </form>

                <a href="{{ url_for('download_report', conversation_id=conversation_id) }}"
                    class="inline-flex items-center gap-2 px-4 py-2 rounded-lg border-2 border-gray-200 text-gray-700 bg-white hover:bg-gray-50 font-medium text-sm transition-all">
                    <span class="material-symbols-outlined text-lg">download</span>
                    Download Report
                </a>

                <a href="{{ url_for('home') }}"
                    class="inline-flex items-center gap-2 px-4 py-2 rounded-lg border-2 border-gray-200 text-gray-700 bg-white hover:bg-gray-50 font-medium text-sm transition-all">
                    <span class="material-symbols-outlined text-lg">arrow_back</span>
                    Back to Home
                </a>
            </div>
        </div>

        <div class="grid lg:grid-cols-[minmax(0,1fr)_minmax(0,1.5fr)] gap-6">

            <section class="bg-white rounded-2xl border-2 border-gray-200 shadow-sm flex flex-col h-[calc(100vh-240px)] fade-in">

                <header class="px-6 py-4 border-b border-gray-200 bg-gradient-to-r from-blue-50 to-white">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="h-10 w-10 rounded-lg bg-gradient-to-br from-primary to-blue-600
                                        flex items-center justify-center shadow-sm">
                                <span class="material-symbols-outlined text-white text-xl">smart_toy</span>
                            </div>
                            <div>
                                <div class="text-base font-semibold text-gray-900">Agent Chat</div>
                                <div class="text-xs text-gray-500">AI Research Assistant</div>
                            </div>
                        </div>

                        <div class="flex items-center gap-2 px-3 py-1.5 rounded-full bg-green-50 border border-green-200">
                            <span class="h-2 w-2 rounded-full bg-green-500 animate-pulse"></span>
                            <span class="text-xs font-medium text-green-700">Active</span>
                        </div>
                    </div>
                </header>

                <div id="chatWindow" class="flex-1 overflow-y-auto px-6 py-4 space-y-4 custom-scrollbar">

                    {% for turn in history %}
                        
                        {# --- USER-INITIATED / SYSTEM EDIT MESSAGE --- #}
                        {% if turn.user != 'System Initiated Pipeline' and turn.user != 'System Initiated Research' %}
                            <div class="flex gap-3 justify-end chat-message">
                                <div class="flex-1 bg-gradient-to-br from-primary to-blue-600 text-white
                                            rounded-2xl rounded-tr-sm px-4 py-3 max-w-[85%] shadow-sm">

                                    <div class="flex items-center gap-2 mb-2 justify-end">
                                        <span class="text-xs font-semibold text-white">{% if "System Edit" in turn.user %}System{% else %}You{% endif %}</span>
                                    </div>

                                    <p class="text-sm leading-relaxed">{{ turn.user | replace("System Edit: ", "") }}</p>
                                </div>

                                <div class="h-8 w-8 rounded-full bg-gray-200 flex items-center justify-center flex-shrink-0">
                                    <span class="material-symbols-outlined text-gray-600 text-sm">person</span>
                                </div>
                            </div>
                            
                            {# Renders the agent's reply immediately after the user's message #}
                            {% if turn.assistant != "" %}
                            <div class="flex gap-3 chat-message">
                                <div class="h-8 w-8 rounded-full bg-gradient-to-br from-primary to-blue-600
                                            flex items-center justify-center flex-shrink-0 shadow-sm">
                                    <span class="material-symbols-outlined text-white text-sm">smart_toy</span>
                                </div>

                                <div class="flex-1 bg-gradient-to-br from-gray-50 to-gray-100 rounded-2xl rounded-tl-sm
                                            px-4 py-3 border border-gray-200">

                                    <div class="flex items-center gap-2 mb-2">
                                        <span class="text-xs font-semibold text-gray-700">AI Agent</span>
                                    </div>

                                    <div class="agent-response-content text-sm text-gray-700 whitespace-pre-wrap leading-relaxed">
                                        {{ turn.assistant }}
                                    </div>
                                    <div class="chart-container mt-3 hidden">
                                        <canvas class="chat-chart"></canvas>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                            
                        {# --- AGENT'S PIPELINE OR PROACTIVE START MESSAGE --- #}
                        {% else %}
                            <div class="flex gap-3 chat-message">
                                <div class="h-8 w-8 rounded-full bg-gradient-to-br from-primary to-blue-600
                                            flex items-center justify-center flex-shrink-0 shadow-sm">
                                    <span class="material-symbols-outlined text-white text-sm">smart_toy</span>
                                </div>
                                <div class="flex-1 bg-gradient-to-br from-gray-50 to-gray-100 rounded-2xl rounded-tl-sm
                                            px-4 py-3 border border-gray-200">
                                    <div class="flex items-center gap-2 mb-2">
                                        <span class="text-xs font-semibold text-gray-700">AI Agent</span>
                                    </div>
                                    <p class="text-sm text-gray-700 whitespace-pre-wrap leading-relaxed ">
                                        {{ turn.assistant }}
                                    </p>
                                </div>
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>

                <form method="post" action="{{ url_for('research_chat_ui', conversation_id=conversation_id) }}"
                      class="border-t border-gray-200 p-4 bg-gray-50">

                    <div class="flex gap-3">
                        <textarea rows="2" name="user_message" required
                            placeholder="Chat with the AI Research Assistant..."
                            class="flex-1 px-4 py-2 rounded-xl border-2 border-gray-200 text-sm text-gray-900
                                   placeholder:text-gray-400 focus:border-primary focus:outline-none resize-none transition-all"></textarea>

                        <button type="submit"
                            class="px-6 py-1 rounded-xl bg-primary text-white font-semibold hover:bg-primary-dark
                                   transition-all flex items-center justify-center gap-2 shadow-sm">

                            <span class="material-symbols-outlined">send</span>
                            <span class="hidden sm:inline">Send</span>
                        </button>
                    </div>
                </form>
            </section>

            <section class="space-y-4 h-[calc(100vh-240px)] overflow-y-auto custom-scrollbar pr-2">

                {% if plan.metadata.conflicts_detected %}
                    <article class="bg-red-50 rounded-2xl border-2 border-red-300 shadow-sm p-6 hover:shadow-md transition-all fade-in">
                        <div class="flex items-start gap-3 mb-4">
                            <div class="h-10 w-10 rounded-lg bg-red-100 flex items-center justify-center flex-shrink-0">
                                <span class="material-symbols-outlined text-red-600 text-xl">gavel</span>
                            </div>
                            <div class="flex-1">
                                <h2 class="text-lg font-bold text-red-800">⚠️ Research Conflicts Detected</h2>
                                <p class="text-xs text-red-600 mt-0.5">The AI flagged conflicting data from its sources. Please check the chat window to resolve this.</p>
                            </div>
                        </div>
                    </article>
                {% endif %}
                
                {% if plan.kpi_summary %}
                    <article class="bg-white rounded-2xl border-2 border-gray-200 shadow-sm p-6 hover:shadow-md transition-all fade-in">
                        <div class="flex items-start gap-3 mb-4">
                            <div class="h-10 w-10 rounded-lg bg-emerald-50 flex items-center justify-center flex-shrink-0">
                                <span class="material-symbols-outlined text-emerald-600 text-xl">trending_up</span>
                            </div>
                            <div class="flex-1">
                                <h2 class="text-lg font-bold text-gray-900">Financial KPI Summary & Chart</h2>
                                <p class="text-xs text-gray-500 mt-0.5">Key metrics visualized for immediate analysis.</p>
                            </div>
                            <span class="px-2 py-1 rounded-md bg-green-50 text-green-700 text-xs font-medium">Data Points: {{ plan.kpi_summary | length }}</span>
                        </div>
                        
                        <div class="mb-4">
                            <canvas id="kpiChart"></canvas>
                        </div>

                        <div class="overflow-x-auto border-t border-gray-100 pt-4">
                            <h3 class="text-sm font-semibold text-gray-700 mb-2">Raw Data Table</h3>
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Metric</th>
                                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Value</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200 text-sm">
                                    {% for kpi in plan.kpi_summary %}
                                    <tr>
                                        <td class="px-3 py-2 whitespace-nowrap">{{ kpi.name }}</td>
                                        <td class="px-3 py-2 whitespace-nowrap font-semibold">{{ kpi.value }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </article>
                {% endif %}
                
                {% if plan.sources.swot_radar_scores %}
                    <article class="bg-white rounded-2xl border-2 border-gray-200 shadow-sm p-6 hover:shadow-md transition-all fade-in">
                        <div class="flex items-start gap-3 mb-4">
                            <div class="h-10 w-10 rounded-lg bg-yellow-50 flex items-center justify-center flex-shrink-0">
                                <span class="material-symbols-outlined text-yellow-600 text-xl">balance</span>
                            </div>
                            <div class="flex-1">
                                <h2 class="text-lg font-bold text-gray-900">SWOT Analysis Visualization</h2>
                                <p class="text-xs text-gray-500 mt-0.5">Visual representation of internal and external factors.</p>
                            </div>
                        </div>
                        <div class="mb-4 h-64">
                            <canvas id="swotRadarChart"></canvas>
                        </div>
                    </article>
                {% endif %}
                
                <article class="bg-white rounded-2xl border-2 border-gray-200 shadow-sm p-6 hover:shadow-md transition-all fade-in">
                    <div class="flex items-start gap-3 mb-4">
                        <div class="h-10 w-10 rounded-lg bg-blue-50 flex items-center justify-center flex-shrink-0">
                            <span class="material-symbols-outlined text-primary text-xl">business</span>
                        </div>
                        <div class="flex-1">
                            <h2 class="text-lg font-bold text-gray-900">Company Overview</h2>
                            <p class="text-xs text-gray-500 mt-0.5">Executive Snapshot</p>
                        </div>
                        <span class="px-2 py-1 rounded-md bg-green-50 text-green-700 text-xs font-medium">Complete</span>
                    </div>

                    <p class="text-sm text-gray-700 leading-relaxed ">
                        {{ plan.overview }}
                    </p>
                </article>

                {% for section in plan.sections %}
                    <article class="bg-white rounded-2xl border-2 border-gray-200 shadow-sm p-6 hover:shadow-md transition-all fade-in" id="section-{{ loop.index }}">
                        <div class="flex items-start gap-3 mb-4">
                            <div class="h-10 w-10 rounded-lg bg-gray-100 flex items-center justify-center flex-shrink-0">
                                <span class="material-symbols-outlined text-gray-700 text-xl">description</span>
                            </div>

                            <div class="flex-1">
                                <h2 class="text-lg font-bold text-gray-900">{{ section.title }}</h2>
                            </div>
                            
                            <button 
                                onclick="openEditModal('{{ section.title }}', '{{ section.content | replace('\n', '\\n') | e }}')"
                                class="inline-flex items-center gap-1 px-3 py-1 rounded-lg border border-gray-300 text-gray-600 bg-white hover:bg-gray-50 text-xs font-medium transition-all"
                            >
                                <span class="material-symbols-outlined text-sm">edit</span>
                                Edit
                            </button>
                            
                            <span class="px-2 py-1 rounded-md bg-green-50 text-green-700 text-xs font-medium">Complete</span>
                        </div>

                        {% if section.title == "Opportunities" %}
                            <ul class="list-disc list-inside space-y-2 text-sm text-gray-700 pl-4">
                                {% for point in section.content.split('\n\n') %}
                                    <li class="pb-1">{{ point }}</li>
                                {% endfor %}
                            </ul>
                       {% elif section.title == "30-60-90 Day Plan" %}
                            {% set plan_table_data = plan.sources.plan_table | default([]) %}
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200 border border-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Period</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Focus</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Metric</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200 text-sm">
                                        {% for row in plan_table_data %}
                                            <tr>
                                                <td class="px-4 py-2 whitespace-nowrap font-semibold">{{ row.period }}</td>
                                                <td class="px-4 py-2">{{ row.focus }}</td>
                                                <td class="px-4 py-2">{{ row.metric }}</td>
                                            </tr>
                                        {% else %}
                                            <tr>
                                                <td colspan="3" class="px-4 py-2 text-center text-gray-500">No detailed plan data available.</td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200 border border-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Period</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Focus</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Metric</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200 text-sm">
                                        {# Split content by newline, skip header lines, and process the data rows #}
                                        {% for row_line in section.content.split('\n') | slice(2, section.content.split('\n') | length) %}
                                            
                                            {# Check if the row_line is a string, not empty, and contains the separator #}
                                            {% if row_line is string and row_line | trim | length > 0 and '|' in row_line %}
                                                
                                                {% set parts = row_line.split('|') %}
                                                {% set cols = parts | map('trim') | reject('equalto', '') | list %}
                                                
                                                {% if cols | length == 3 %}
                                                    <tr>
                                                        <td class="px-4 py-2 whitespace-nowrap font-semibold">{{ cols[0] }}</td>
                                                        <td class="px-4 py-2">{{ cols[1] }}</td>
                                                        <td class="px-4 py-2">{{ cols[2] }}</td>
                                                    </tr>
                                                {% endif %}
                                            {% endif %}
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% else %}
                            <p class="text-sm text-gray-700 whitespace-pre-wrap leading-relaxed ">
                                {{ section.content }}
                            </p>
                        {% endif %}
                    </article>
                {% endfor %}
            </section>
        </div>
    </div>
</main>

<div id="editModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50">
    <div class="bg-white rounded-2xl w-full max-w-xl p-6 shadow-2xl">
        <h3 class="text-xl font-bold mb-4 text-gray-900">Edit Section: <span id="modalSectionTitle" class="text-primary"></span></h3>
        
        <form id="editForm" method="post" action="#">
            <input type="hidden" name="section_title" id="editSectionTitleInput">
            
            <label for="newContent" class="block text-sm font-medium text-gray-700 mb-2">New Content</label>
            <textarea 
                id="newContent" 
                name="new_content" 
                rows="8"
                required
                class="w-full px-4 py-3 rounded-lg border-2 border-gray-200 text-gray-900 placeholder:text-gray-400 focus:border-primary focus:outline-none transition-all resize-none"
            ></textarea>

            <div class="flex justify-end gap-3 mt-6">
                <button 
                    type="button" 
                    onclick="closeEditModal()"
                    class="px-6 py-2 rounded-lg border-2 border-gray-200 bg-white text-gray-700 font-semibold hover:bg-gray-50 transition-all"
                >
                    Cancel
                </button>
                <button 
                    type="submit"
                    class="px-6 py-2 rounded-lg bg-primary text-white font-semibold hover:bg-primary-dark transition-all"
                >
                    Save Changes
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    // --- JINJA DATA TRANSFER ---
    const rawKpiData = JSON.parse('{{ plan.kpi_summary | tojson | safe }}');
    const swotScores = JSON.parse('{{ plan.sources.swot_radar_scores | tojson | safe }}');
    
    const chartColors = [
        'rgba(37, 99, 235, 0.8)', // Primary Blue
        'rgba(16, 185, 129, 0.8)', // Emerald Green
        'rgba(251, 191, 36, 0.8)', // Amber Yellow
        'rgba(239, 68, 68, 0.8)' // Red
    ];
    
    // --- CHART RENDERING FUNCTIONS ---
    
    function renderKpiChart() {
        if (!rawKpiData || rawKpiData.length === 0) return;

        const chartLabels = rawKpiData.map(item => item.name.split('(')[0].trim());
        const chartValues = rawKpiData.map(item => item.value);

        const ctx = document.getElementById('kpiChart').getContext('2d');
        
        new Chart(ctx, {
            type: 'bar', 
            data: {
                labels: chartLabels,
                datasets: [{
                    label: 'KPI Value',
                    data: chartValues,
                    backgroundColor: chartColors.slice(0, chartLabels.length),
                    borderColor: chartColors.map(c => c.replace('0.8', '1')),
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    title: { display: true, text: 'Key Performance Indicators' }
                },
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });
    }

    function renderSwotRadarChart() {
        if (!swotScores || Object.keys(swotScores).length === 0) return;

        const labels = Object.keys(swotScores); // Strength, Weakness, Opportunity, Threat
        const data = Object.values(swotScores);
        
        const ctx = document.getElementById('swotRadarChart').getContext('2d');

        new Chart(ctx, {
            type: 'radar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Score (1-10)',
                    data: data,
                    backgroundColor: 'rgba(251, 191, 36, 0.2)', // Light Amber
                    borderColor: 'rgba(251, 191, 36, 1)',
                    pointBackgroundColor: 'rgba(251, 191, 36, 1)',
                    pointBorderColor: '#fff',
                    pointHoverBackgroundColor: '#fff',
                    pointHoverBorderColor: 'rgba(251, 191, 36, 1)'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    r: {
                        angleLines: { display: true },
                        suggestedMin: 0,
                        suggestedMax: 10,
                        ticks: { stepSize: 2 }
                    }
                }
            }
        });
    }

    function renderDynamicChatChart(container, chartData, chartType, chartTitle) {
        const data = chartData.data;
        const ctx = container.getContext('2d');
        let chartConfig = {};

        if (chartType === 'pie') {
            chartConfig = {
                type: 'pie',
                data: {
                    labels: data.map(item => item.name),
                    datasets: [{
                        data: data.map(item => item.share_percent),
                        backgroundColor: chartColors.slice(0, data.length),
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: { display: true, text: chartTitle }
                    }
                }
            };
        } else if (chartType === 'radar') {
             // Re-use logic from SWOT chart
             const labels = Object.keys(data);
             const values = Object.values(data);
             
             chartConfig = {
                type: 'radar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Score (1-10)',
                        data: values,
                        backgroundColor: 'rgba(37, 99, 235, 0.2)', // Light Blue
                        borderColor: 'rgba(37, 99, 235, 1)',
                        pointBackgroundColor: 'rgba(37, 99, 235, 1)',
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { r: { suggestedMin: 0, suggestedMax: 10, ticks: { stepSize: 2 } } }
                }
            };
        }

        if (chartConfig.type) {
            new Chart(ctx, chartConfig);
        }
    }
    
    // --- MAIN DOM INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', function() {
        var chatWindow = document.getElementById('chatWindow');
        if (chatWindow) {
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        // 1. Render static right-panel charts
        if (rawKpiData && rawKpiData.length > 0) { renderKpiChart(); }
        if (swotScores && Object.keys(swotScores).length > 0) { renderSwotRadarChart(); }

        // 2. Scan chat window for dynamic chart requests
        document.querySelectorAll('.agent-response-content').forEach(contentDiv => {
            const text = contentDiv.textContent.trim();
            
            try {
                const chartRequest = JSON.parse(text);
                
                if (chartRequest.reply_type === 'chart_request' && chartRequest.data) {
                    const chatBubble = contentDiv.closest('.flex-1');
                    const chartCanvas = chatBubble.querySelector('.chat-chart');

                    if (chartCanvas) {
                        // Hide the JSON text and show the chart container
                        contentDiv.classList.add('hidden');
                        chatBubble.querySelector('.chart-container').classList.remove('hidden');

                        renderDynamicChatChart(
                            chartCanvas,
                            chartRequest,
                            chartRequest.chart_type,
                            chartRequest.title
                        );
                    }
                }
            } catch (e) {
                // Not a JSON chart request, treat as normal text
            }
        });
    });

    // Modal functions for Selective Editing (Unchanged)
    function openEditModal(title, content) {
        document.getElementById('modalSectionTitle').textContent = title;
        document.getElementById('editSectionTitleInput').value = title;
        document.getElementById('newContent').value = content.replace(/\\n/g, '\n'); 
        
        const conversationId = '{{ conversation_id }}';
        document.getElementById('editForm').action = `/ui/research/${conversationId}/edit`; 

        document.getElementById('editModal').classList.remove('hidden');
        document.getElementById('editModal').classList.add('flex');
    }

    function closeEditModal() {
        document.getElementById('editModal').classList.remove('flex');
        document.getElementById('editModal').classList.add('hidden');
    }
</script>

</body>
</html>

{% endblock %}